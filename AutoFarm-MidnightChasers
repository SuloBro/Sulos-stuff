local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local MarketplaceService = game:GetService("MarketplaceService")
local player = Players.LocalPlayer

local PREMIUM_SHIRT_ID = 132268448125497
local DRIVE_SPEED_NORMAL = 350
local DRIVE_SPEED_PREMIUM = 500
local CHECKPOINT_DISTANCE = 50
local WAIT_BEFORE_START = 8

local RACE_NAMES = {
    Race1 = "City Highway Race",
    Race2 = "Rainbow Bridge Sprint",
    Race3 = "Doro Sprint",
    Race4 = "Rainbow Rinkai Doro Sprint"
}

local selectedRace = "Race1"
local raceActive = false
local currentCheckpoint = 1
local carModel = nil
local carPrimary = nil
local checkpointDetectionLoop = nil
local isPremium = false
local finishReached = false
local lastPositions = {}
local stuckCheckLoop = nil

local function CheckPremiumStatus()
    local success, owns = pcall(function()
        return MarketplaceService:UserOwnsGamePassAsync(player.UserId, PREMIUM_SHIRT_ID)
    end)
    isPremium = success and owns
    return isPremium
end

local function SetCarCollisions(car, canCollide)
    if not car then return end
    for _, part in pairs(car:GetDescendants()) do
        if part:IsA("BasePart") then
            part.CanCollide = canCollide
        end
    end
end

local function DisableNPCCollisions()
    local npcVehiclesFolder = workspace:FindFirstChild("NPCVehicles")
    if npcVehiclesFolder then
        local vehiclesFolder = npcVehiclesFolder:FindFirstChild("Vehicles")
        if vehiclesFolder then
            for _, vehicle in pairs(vehiclesFolder:GetChildren()) do
                if vehicle:IsA("Model") or vehicle:IsA("Folder") then
                    for _, descendant in pairs(vehicle:GetDescendants()) do
                        if descendant:IsA("BasePart") then
                            descendant.CanCollide = false
                        end
                    end
                end
            end
        end
    end
end

local function IsInRaceUI()
    local racesGui = player.PlayerGui:FindFirstChild("Races")
    if not racesGui then return false end
    
    local container = racesGui:FindFirstChild("Container")
    if container and container.Visible then
        return true
    end
    
    return false
end

local function HasRaceEnded()
    local racesGui = player.PlayerGui:FindFirstChild("Races")
    if not racesGui then return false end
    
    local results = racesGui:FindFirstChild("Results")
    if results and results.Visible then
        return true
    end
    
    return false
end

local function GetCheckpointsFolder()
    local races = workspace:FindFirstChild("Races")
    if not races then return nil end
    
    local race = races:FindFirstChild(selectedRace)
    if not race then return nil end
    
    local racesFolder = race:FindFirstChild("Races")
    if not racesFolder then return nil end
    
    for _, folder in pairs(racesFolder:GetChildren()) do
        if folder:IsA("Folder") and folder.Name:match("^" .. selectedRace .. "_") then
            local checkpointsValue = folder:FindFirstChild("Checkpoints")
            if checkpointsValue then
                return checkpointsValue
            end
        end
    end
    
    return nil
end

local function FindCheckpoint(number)
    local folder = GetCheckpointsFolder()
    if not folder then return nil end
    
    local checkpoint = folder:FindFirstChild(tostring(number))
    if checkpoint and checkpoint:IsA("BasePart") then
        return checkpoint
    end
    
    return nil
end

local function FindFinish()
    local folder = GetCheckpointsFolder()
    if not folder then return nil end
    
    local finish = folder:FindFirstChild("Finish")
    if finish and finish:IsA("BasePart") then
        return finish
    end
    
    return nil
end

local function IsPlayerInCar()
    if not player.Character then return false end
    
    local humanoid = player.Character:FindFirstChild("Humanoid")
    if humanoid and humanoid.Sit and humanoid.SeatPart then
        return true
    end
    
    return false
end

local function GetPlayerCar()
    if not player.Character then return nil end
    
    local humanoid = player.Character:FindFirstChild("Humanoid")
    if humanoid and humanoid.SeatPart then
        return humanoid.SeatPart.Parent
    end
    
    return nil
end

local function GetDistanceToCheckpoint(checkpoint)
    if not carPrimary or not carPrimary.Parent then return math.huge end
    if not checkpoint or not checkpoint.Parent then return math.huge end
    
    return (carPrimary.Position - checkpoint.Position).Magnitude
end

local function SavePosition()
    if not carPrimary or not carPrimary.Parent then return end
    
    table.insert(lastPositions, {
        position = carPrimary.Position,
        time = tick()
    })
    
    if #lastPositions > 5 then
        table.remove(lastPositions, 1)
    end
end

local function IsCarStuck()
    if #lastPositions < 3 then return false end
    
    local recentPositions = {}
    for i = math.max(1, #lastPositions - 2), #lastPositions do
        table.insert(recentPositions, lastPositions[i].position)
    end
    
    local totalDistance = 0
    for i = 1, #recentPositions - 1 do
        totalDistance = totalDistance + (recentPositions[i] - recentPositions[i + 1]).Magnitude
    end
    
    return totalDistance < 5
end

local function DriveToCheckpoint(checkpoint)
    if not carModel or not carPrimary or not checkpoint then return end
    
    local targetPos = checkpoint.Position
    local currentPos = carPrimary.Position
    local direction = (targetPos - currentPos).Unit
    
    local lookDirection = Vector3.new(direction.X, 0, direction.Z).Unit
    local targetCFrame = CFrame.new(currentPos, currentPos + lookDirection)
    
    carPrimary.CFrame = targetCFrame
    
    wait(0.05)
    
    local speed = isPremium and DRIVE_SPEED_PREMIUM or DRIVE_SPEED_NORMAL
    carPrimary.AssemblyLinearVelocity = direction * speed
end

local function StopRacing()
    raceActive = false
    finishReached = false
    
    if checkpointDetectionLoop then
        checkpointDetectionLoop:Disconnect()
        checkpointDetectionLoop = nil
    end
    
    if stuckCheckLoop then
        stuckCheckLoop:Disconnect()
        stuckCheckLoop = nil
    end
    
    if carPrimary and carPrimary.Parent then
        carPrimary.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
        carPrimary.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
    end
    
    if carModel then
        SetCarCollisions(carModel, true)
    end
    
    carModel = nil
    carPrimary = nil
    currentCheckpoint = 1
    lastPositions = {}
end

local statusText = nil

local function StartRacing()
    if raceActive then return end
    
    if not IsPlayerInCar() then
        return
    end
    
    carModel = GetPlayerCar()
    if not carModel then return end
    
    carPrimary = carModel:FindFirstChild("Body") and carModel.Body:FindFirstChild("#Weight")
    if not carPrimary then
        carPrimary = carModel.PrimaryPart or carModel:FindFirstChild("VehicleSeat")
    end
    
    if not carPrimary then return end
    
    carModel.PrimaryPart = carPrimary
    raceActive = true
    currentCheckpoint = 1
    finishReached = false
    lastPositions = {}
    
    CheckPremiumStatus()
    
    spawn(function()
        for i = WAIT_BEFORE_START, 1, -1 do
            if not raceActive then return end
            if statusText then
                statusText.Text = "Status: Starting in " .. i .. "s"
                statusText.TextColor3 = Color3.fromRGB(255, 200, 100)
            end
            wait(1)
        end
        
        if not raceActive then return end
        
        if statusText then
            statusText.Text = "Status: Racing"
            statusText.TextColor3 = Color3.fromRGB(100, 255, 100)
        end
        
        SetCarCollisions(carModel, false)
        
        spawn(function()
            while raceActive do
                DisableNPCCollisions()
                if carModel then
                    SetCarCollisions(carModel, false)
                end
                wait(1)
            end
        end)
        
        stuckCheckLoop = RunService.Heartbeat:Connect(function()
            if not raceActive then return end
            SavePosition()
            
            if IsCarStuck() then
                local checkpoint = FindCheckpoint(currentCheckpoint)
                if not checkpoint then
                    checkpoint = FindFinish()
                end
                
                if checkpoint then
                    DriveToCheckpoint(checkpoint)
                end
            end
        end)
        
        checkpointDetectionLoop = RunService.Heartbeat:Connect(function()
            if not raceActive then return end
            
            if HasRaceEnded() then
                StopRacing()
                return
            end
            
            if not IsInRaceUI() then
                StopRacing()
                return
            end
            
            if not IsPlayerInCar() then
                StopRacing()
                return
            end
            
            if not carModel or not carModel.Parent or not carPrimary or not carPrimary.Parent then
                StopRacing()
                return
            end
            
            if finishReached then return end
            
            local checkpoint = FindCheckpoint(currentCheckpoint)
            
            if checkpoint then
                local distance = GetDistanceToCheckpoint(checkpoint)
                
                if distance <= CHECKPOINT_DISTANCE then
                    currentCheckpoint = currentCheckpoint + 1
                    wait(0.5)
                else
                    DriveToCheckpoint(checkpoint)
                end
            else
                local finish = FindFinish()
                if finish then
                    local distanceToFinish = GetDistanceToCheckpoint(finish)
                    
                    if distanceToFinish <= CHECKPOINT_DISTANCE and not finishReached then
                        finishReached = true
                        if statusText then
                            statusText.Text = "Status: Finishing..."
                            statusText.TextColor3 = Color3.fromRGB(100, 255, 255)
                        end
                        wait(3)
                        StopRacing()
                        return
                    else
                        DriveToCheckpoint(finish)
                    end
                else
                    currentCheckpoint = currentCheckpoint + 1
                    if currentCheckpoint > 50 then
                        currentCheckpoint = 1
                    end
                end
            end
        end)
    end)
end

local guiScreen = Instance.new("ScreenGui")
guiScreen.Name = "AutoRaceGUI"
guiScreen.DisplayOrder = 50000
guiScreen.ResetOnSpawn = false
guiScreen.IgnoreGuiInset = true
guiScreen.Parent = player.PlayerGui

local guiFrame = Instance.new("Frame")
guiFrame.Size = UDim2.new(0, 360, 0, 280)
guiFrame.Position = UDim2.new(0.5, -180, 0.5, -140)
guiFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 28)
guiFrame.BorderSizePixel = 0
guiFrame.Parent = guiScreen

local frameCorner = Instance.new("UICorner")
frameCorner.CornerRadius = UDim.new(0, 12)
frameCorner.Parent = guiFrame

local frameStroke = Instance.new("UIStroke")
frameStroke.Color = Color3.fromRGB(45, 45, 50)
frameStroke.Thickness = 1
frameStroke.Parent = guiFrame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -20, 0, 30)
title.Position = UDim2.new(0, 10, 0, 10)
title.BackgroundTransparency = 1
title.Text = "Sulo's Auto Race! ( gg.pKQVm2P6B7 )"
title.TextColor3 = Color3.fromRGB(240, 240, 240)
title.TextSize = 20
title.Font = Enum.Font.GothamBold
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = guiFrame

local subtitle = Instance.new("TextLabel")
subtitle.Size = UDim2.new(1, -20, 0, 16)
subtitle.Position = UDim2.new(0, 10, 0, 42)
subtitle.BackgroundTransparency = 1
subtitle.Text = "Premium Users will complete the race faster"
subtitle.TextColor3 = Color3.fromRGB(150, 150, 150)
subtitle.TextSize = 11
subtitle.Font = Enum.Font.Gotham
subtitle.TextXAlignment = Enum.TextXAlignment.Left
subtitle.Parent = guiFrame

local raceDropdown = Instance.new("TextButton")
raceDropdown.Size = UDim2.new(1, -20, 0, 40)
raceDropdown.Position = UDim2.new(0, 10, 0, 70)
raceDropdown.BackgroundColor3 = Color3.fromRGB(35, 35, 38)
raceDropdown.BorderSizePixel = 0
raceDropdown.Text = "City Highway Race"
raceDropdown.TextColor3 = Color3.fromRGB(220, 220, 220)
raceDropdown.TextSize = 14
raceDropdown.Font = Enum.Font.GothamMedium
raceDropdown.TextXAlignment = Enum.TextXAlignment.Left
raceDropdown.Parent = guiFrame

local dropdownPadding = Instance.new("UIPadding")
dropdownPadding.PaddingLeft = UDim.new(0, 12)
dropdownPadding.Parent = raceDropdown

local dropdownCorner = Instance.new("UICorner")
dropdownCorner.CornerRadius = UDim.new(0, 10)
dropdownCorner.Parent = raceDropdown

local dropdownStroke = Instance.new("UIStroke")
dropdownStroke.Color = Color3.fromRGB(55, 55, 60)
dropdownStroke.Thickness = 1
dropdownStroke.Parent = raceDropdown

local dropdownArrow = Instance.new("TextLabel")
dropdownArrow.Size = UDim2.new(0, 30, 1, 0)
dropdownArrow.Position = UDim2.new(1, -35, 0, 0)
dropdownArrow.BackgroundTransparency = 1
dropdownArrow.Text = "⇩"
dropdownArrow.TextColor3 = Color3.fromRGB(180, 180, 180)
dropdownArrow.TextSize = 16
dropdownArrow.Font = Enum.Font.GothamBold
dropdownArrow.Parent = raceDropdown

local dropdownList = Instance.new("Frame")
dropdownList.Size = UDim2.new(1, -20, 0, 164)
dropdownList.Position = UDim2.new(0, 10, 0, 115)
dropdownList.BackgroundColor3 = Color3.fromRGB(32, 32, 35)
dropdownList.BorderSizePixel = 0
dropdownList.Visible = false
dropdownList.ZIndex = 5
dropdownList.Parent = guiFrame

local listCorner = Instance.new("UICorner")
listCorner.CornerRadius = UDim.new(0, 10)
listCorner.Parent = dropdownList

local listStroke = Instance.new("UIStroke")
listStroke.Color = Color3.fromRGB(55, 55, 60)
listStroke.Thickness = 1
listStroke.Parent = dropdownList

local listLayout = Instance.new("UIListLayout")
listLayout.Padding = UDim.new(0, 2)
listLayout.Parent = dropdownList

for i = 1, 4 do
    local raceKey = "Race" .. i
    local raceName = RACE_NAMES[raceKey]
    
    local raceOption = Instance.new("TextButton")
    raceOption.Size = UDim2.new(1, 0, 0, 40)
    raceOption.BackgroundColor3 = Color3.fromRGB(32, 32, 35)
    raceOption.BorderSizePixel = 0
    raceOption.Text = raceName
    raceOption.TextColor3 = Color3.fromRGB(220, 220, 220)
    raceOption.TextSize = 13
    raceOption.Font = Enum.Font.GothamMedium
    raceOption.TextXAlignment = Enum.TextXAlignment.Left
    raceOption.ZIndex = 6
    raceOption.Parent = dropdownList
    
    local optionPadding = Instance.new("UIPadding")
    optionPadding.PaddingLeft = UDim.new(0, 12)
    optionPadding.Parent = raceOption
    
    if i == 1 then
        local topCorner = Instance.new("UICorner")
        topCorner.CornerRadius = UDim.new(0, 10)
        topCorner.Parent = raceOption
    end
    
    if i == 4 then
        local bottomCorner = Instance.new("UICorner")
        bottomCorner.CornerRadius = UDim.new(0, 10)
        bottomCorner.Parent = raceOption
    end
    
    raceOption.MouseEnter:Connect(function()
        raceOption.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
    end)
    
    raceOption.MouseLeave:Connect(function()
        raceOption.BackgroundColor3 = Color3.fromRGB(32, 32, 35)
    end)
    
    raceOption.MouseButton1Click:Connect(function()
        selectedRace = raceKey
        raceDropdown.Text = raceName
        dropdownList.Visible = false
        dropdownArrow.Text = "⇩"
    end)
end

raceDropdown.MouseButton1Click:Connect(function()
    dropdownList.Visible = not dropdownList.Visible
    dropdownArrow.Text = dropdownList.Visible and "⇧" or "⇩"
end)

statusText = Instance.new("TextLabel")
statusText.Size = UDim2.new(1, -20, 0, 22)
statusText.Position = UDim2.new(0, 10, 0, 120)
statusText.BackgroundTransparency = 1
statusText.Text = "Status: Idle"
statusText.TextColor3 = Color3.fromRGB(180, 180, 180)
statusText.TextSize = 13
statusText.Font = Enum.Font.GothamMedium
statusText.TextXAlignment = Enum.TextXAlignment.Left
statusText.Parent = guiFrame

local checkpointText = Instance.new("TextLabel")
checkpointText.Size = UDim2.new(1, -20, 0, 22)
checkpointText.Position = UDim2.new(0, 10, 0, 145)
checkpointText.BackgroundTransparency = 1
checkpointText.Text = "Checkpoint: 0"
checkpointText.TextColor3 = Color3.fromRGB(180, 180, 180)
checkpointText.TextSize = 13
checkpointText.Font = Enum.Font.GothamMedium
checkpointText.TextXAlignment = Enum.TextXAlignment.Left
checkpointText.Parent = guiFrame

local premiumText = Instance.new("TextLabel")
premiumText.Size = UDim2.new(1, -20, 0, 22)
premiumText.Position = UDim2.new(0, 10, 0, 170)
premiumText.BackgroundTransparency = 1
premiumText.Text = "Premium: " .. (CheckPremiumStatus() and "Active ⚡" or "Inactive")
premiumText.TextColor3 = isPremium and Color3.fromRGB(100, 200, 255) or Color3.fromRGB(150, 150, 150)
premiumText.TextSize = 12
premiumText.Font = Enum.Font.GothamMedium
premiumText.TextXAlignment = Enum.TextXAlignment.Left
premiumText.Parent = guiFrame

local startButton = Instance.new("TextButton")
startButton.Size = UDim2.new(0, 165, 0, 50)
startButton.Position = UDim2.new(0, 10, 0, 210)
startButton.Text = "Start Farm"
startButton.TextColor3 = Color3.fromRGB(255, 255, 255)
startButton.TextSize = 15
startButton.Font = Enum.Font.GothamBold
startButton.BackgroundColor3 = Color3.fromRGB(70, 130, 70)
startButton.BorderSizePixel = 0
startButton.Parent = guiFrame

local startCorner = Instance.new("UICorner")
startCorner.CornerRadius = UDim.new(0, 10)
startCorner.Parent = startButton

local startStroke = Instance.new("UIStroke")
startStroke.Color = Color3.fromRGB(90, 160, 90)
startStroke.Thickness = 0
startStroke.Parent = startButton

local stopButton = Instance.new("TextButton")
stopButton.Size = UDim2.new(0, 165, 0, 50)
stopButton.Position = UDim2.new(0, 185, 0, 210)
stopButton.Text = "Stop"
stopButton.TextColor3 = Color3.fromRGB(255, 255, 255)
stopButton.TextSize = 15
stopButton.Font = Enum.Font.GothamBold
stopButton.BackgroundColor3 = Color3.fromRGB(130, 70, 70)
stopButton.BorderSizePixel = 0
stopButton.Parent = guiFrame

local stopCorner = Instance.new("UICorner")
stopCorner.CornerRadius = UDim.new(0, 10)
stopCorner.Parent = stopButton

local stopStroke = Instance.new("UIStroke")
stopStroke.Color = Color3.fromRGB(160, 90, 90)
stopStroke.Thickness = 0
stopStroke.Parent = stopButton

local function addButtonHover(button, normalColor, hoverColor, stroke)
    local originalSize = button.Size
    local pressedSize = UDim2.new(originalSize.X.Scale, originalSize.X.Offset - 4, originalSize.Y.Scale, originalSize.Y.Offset - 4)
    
    button.MouseEnter:Connect(function()
        TweenService:Create(button, TweenInfo.new(0.2), {
            BackgroundColor3 = hoverColor
        }):Play()
        if stroke then
            TweenService:Create(stroke, TweenInfo.new(0.2), {
                Thickness = 2
            }):Play()
        end
    end)
    
    button.MouseLeave:Connect(function()
        TweenService:Create(button, TweenInfo.new(0.2), {
            BackgroundColor3 = normalColor
        }):Play()
        if stroke then
            TweenService:Create(stroke, TweenInfo.new(0.2), {
                Thickness = 0
            }):Play()
        end
    end)
    
    button.MouseButton1Down:Connect(function()
        TweenService:Create(button, TweenInfo.new(0.1), {
            Size = pressedSize
        }):Play()
    end)
    
    button.MouseButton1Up:Connect(function()
        TweenService:Create(button, TweenInfo.new(0.1), {
            Size = originalSize
        }):Play()
    end)
end

addButtonHover(startButton, Color3.fromRGB(70, 130, 70), Color3.fromRGB(85, 155, 85), startStroke)
addButtonHover(stopButton, Color3.fromRGB(130, 70, 70), Color3.fromRGB(155, 85, 85), stopStroke)
addButtonHover(raceDropdown, Color3.fromRGB(35, 35, 38), Color3.fromRGB(45, 45, 48), dropdownStroke)

startButton.MouseButton1Click:Connect(function()
    if not IsPlayerInCar() then
        statusText.Text = "Status: Get in car first"
        statusText.TextColor3 = Color3.fromRGB(255, 130, 130)
        wait(2)
        if not raceActive then
            statusText.Text = "Status: Idle"
            statusText.TextColor3 = Color3.fromRGB(180, 180, 180)
        end
        return
    end
    
    StartRacing()
end)

stopButton.MouseButton1Click:Connect(function()
    StopRacing()
    statusText.Text = "Status: Stopped"
    statusText.TextColor3 = Color3.fromRGB(180, 180, 180)
    checkpointText.Text = "Checkpoint: 0"
end)

spawn(function()
    while wait(0.5) do
        if raceActive then
            checkpointText.Text = "Checkpoint: " .. currentCheckpoint
        end
    end
end)

local dragging = false
local dragInput
local dragStart
local startPos

local function update(input)
    local delta = input.Position - dragStart
    guiFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

guiFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = guiFrame.Position

        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

guiFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)
